#!/bin/bash
#------------------------------------------------------------------------------
# Test timeout time
#------------------------------------------------------------------------------
if [ -z $2 ]
then
    t="28"
else
    t="$2"
fi
#------------------------------------------------------------------------------
# Test packs count
#------------------------------------------------------------------------------
if [ -z $3 ]
then
    p="500"
else
    p="$3"
fi
#------------------------------------------------------------------------------
# Test filename var
#------------------------------------------------------------------------------
if [ -z $1 ]
then
    BASEDIR=`dirname $0`
    DIRPATH=`cd $BASEDIR; pwd`
    f=$DIRPATH/data/print_toptlk
else
    f="$1"
    printf "<table border=\"1\"><tr><td>NOTHING</td></tr></table>\n" > $f
    exit 0
fi
#------------------------------------------------------------------------------
# Print top talkers
#------------------------------------------------------------------------------
printf "<table border=\"1\">\n" > $f
sudo timeout $t tcpdump -tnn -c $p | awk -F "." \
'{print $1"."$2"."$3"."$4}' | sort | uniq -c | sort -nr | awk '$1 > 1' | awk -F " " \
'{ print "<tr><td>"NR"</td><td>"$1"</td><td>"$2 $3"</td></tr>" }' >> $f
lines=`cat $f | wc -l`
if [ $lines < 2 ]
then
	printf "<tr><td>NOTHING</td></tr>" >> $f
fi
printf "\n</table>\n" >> $f
#------------------------------------------------------------------------------